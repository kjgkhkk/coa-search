<!DOCTYPE html>
<html>
<head>
    <title>Gunster Biotech — CoA Search & Download (Fast)</title>
</head>
<body>
    <h1>Gunster Biotech — CoA Search & Download (Fast)</h1>
    <input type="text" id="searchInput" placeholder="Enter keyword">
    <button onclick="searchFiles()">Search</button>
    <button onclick="clearResults()">Clear</button>
    <table border="1" id="resultsTable">
        <tr>
            <th>#</th>
            <th>Filename</th>
            <th>Folder</th>
            <th>Last Modified</th>
            <th>Action</th>
        </tr>
    </table>

    <script>
        const API_KEY = 'AIzaSyCHe4kvj5Mgv9MTdS9rL5Dxrg8d2qrTkzI';
        const FOLDER_ID = '1cstVGEu9aSqYnSMNJsbH_-2s1wtn-jsj';

        // 批次取得多個資料夾名稱
        async function getFolderNames(folderIds) {
            const uniqueIds = [...new Set(folderIds)];
            const folderMap = {};

            await Promise.all(uniqueIds.map(async (id) => {
                const url = `https://www.googleapis.com/drive/v3/files/${id}?key=${API_KEY}&fields=name&supportsAllDrives=true`;
                const res = await fetch(url);
                const data = await res.json();
                folderMap[id] = data.name || '(No Folder)';
            }));

            return folderMap;
        }

        async function searchFiles() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const resultsTable = document.getElementById('resultsTable');

            // 顯示正在搜尋提示
            resultsTable.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align:center;color:blue;">⏳ 正在搜尋，請稍候...</td>
                </tr>`;

            let pageToken = null;
            let counter = 1;
            let allFiles = [];

            // 抓所有符合關鍵字的檔案
            do {
                const res = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+trashed=false+and+name+contains+'${keyword}'&fields=files(id,name,parents,modifiedTime),nextPageToken&pageSize=100&supportsAllDrives=true&includeItemsFromAllDrives=true&pageToken=${pageToken||''}&key=${API_KEY}`
                );
                const data = await res.json();
                allFiles.push(...data.files);
                pageToken = data.nextPageToken;
            } while (pageToken);

            // 批次取得所有資料夾名稱
            const parentIds = allFiles.flatMap(f => f.parents || []);
            const folderMap = await getFolderNames(parentIds);

            // 顯示結果
            resultsTable.innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Filename</th>
                    <th>Folder</th>
                    <th>Last Modified</th>
                    <th>Action</th>
                </tr>`;

            allFiles.forEach(file => {
                const row = resultsTable.insertRow();
                row.insertCell(0).innerText = counter++;
                row.insertCell(1).innerText = file.name;
                row.insertCell(2).innerText = folderMap[file.parents?.[0]] || '';
                row.insertCell(3).innerText = new Date(file.modifiedTime).toLocaleString();
                const linkCell = row.insertCell(4);
                const link = document.createElement('a');
                link.href = `https://drive.google.com/uc?id=${file.id}&export=download`;
                link.innerText = 'Download';
                linkCell.appendChild(link);
            });
        }

        function clearResults() {
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsTable').innerHTML = `
                <tr>
                    <th>#</th>
                    <th>Filename</th>
                    <th>Folder</th>
                    <th>Last Modified</th>
                    <th>Action</th>
                </tr>`;
        }
    </script>
</body>
</html>
