<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Gunster Biotech — CoA Search (Product + Lot)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", sans-serif; }
    h1 { margin: 16px 0; }
    .controls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    select, input, button { padding:6px 8px; font-size:14px; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; max-width: 1080px; }
    th, td { border:1px solid #888; padding:6px 8px; }
    th { background:#f2f2f2; }
    #statusMsg { margin:8px 0; color:#0b5bd3; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h1>Gunster Biotech — CoA Search (Product + Lot)</h1>

  <div class="controls">
    <label>品名：</label>
    <select id="productSelect">
      <option value="">（不指定）</option>
      <option>MB-P02-A</option>
      <option>MB-P02D</option>
      <option>MB-P08A</option>
      <option>MB-P08B</option>
      <option>MB-P08D</option>
      <option>MB-P08AD</option>
      <option>MB-Q100</option>
      <option>MB-Q100A</option>
      <option>MB-Q100C</option>
      <option>MB-Q100W</option>
      <option>MB-Q200</option>
      <option>MB-Q200A</option>
      <option>MB-Q200W</option>
      <option>MB-Optical Cap</option>
      <option>MB-P08B-Cap</option>
      <option>MB-P08D-Cap</option>
      <option>MB-QR4</option>
      <option>MB-P96</option>
      <option>MB-P96-T</option>
      <option>MB-Q96</option>
      <option>MB-Q96-S</option>
      <option>MB-Q96-LN</option>
      <option>MB-Q96-LP</option>
      <option>MB-Q96-LBR</option>
      <option>MB-Q96-LBR-W</option>
      <option>MB-E17</option>
      <option>MB-384</option>
      <option>MB-384W</option>
      <option>MB-PSM</option>
      <option>MB-QSM</option>
      <option>MB-BQSM</option>
      <option>MB-ASM</option>
      <option>MB-ESM</option>
    </select>

    <label>Lot number：</label>
    <input id="lotInput" type="text" placeholder="例如 107053（6碼以上數字）" inputmode="numeric" />
    <button onclick="searchFiles()">Search</button>
    <button onclick="clearResults()">Clear</button>
  </div>

  <div id="statusMsg"></div>
  <div class="muted">提示：只填「Lot」會用快速全域搜尋；同時選「品名 + Lot」更快更準。</div>

  <table id="resultsTable">
    <tr>
      <th>#</th>
      <th>Filename</th>
      <th>Folder</th>
      <th>Last Modified</th>
      <th>Action</th>
    </tr>
  </table>

  <script>
    // 你的金鑰與根資料夾
    const API_KEY   = 'AIzaSyCHe4kvj5Mgv9MTdS9rL5Dxrg8d2qrTkzI';
    const FOLDER_ID = '1cstVGEu9aSqYnSMNJsbH_-2s1wtn-jsj';
    const supports  = '&supportsAllDrives=true&includeItemsFromAllDrives=true';

    // ---- 併發限制，避免一次太多請求 ----
    function createLimiter(maxConcurrent = 8) {
      let running = 0; const q = [];
      const runNext = () => {
        if (running >= maxConcurrent || !q.length) return;
        running++;
        const { fn, res, rej } = q.shift();
        fn().then(v => { running--; res(v); runNext(); })
            .catch(e => { running--; rej(e); runNext(); });
      };
      return fn => new Promise((res, rej) => { q.push({ fn, res, rej }); runNext(); });
    }
    const limit = createLimiter(8);

    // 批次取資料夾名稱
    async function getFolderNames(ids) {
      const uniq = [...new Set(ids.filter(Boolean))];
      const map = {};
      await Promise.all(uniq.map(id => limit(async () => {
        const url = `https://www.googleapis.com/drive/v3/files/${id}?key=${API_KEY}&fields=name${supports}`;
        const r = await fetch(url); const j = await r.json();
        map[id] = j && j.name ? j.name : '(No Folder)';
      })));
      return map;
    }

    // 在某資料夾內用 name contains 子句篩選（回檔案與子資料夾）
    async function listInFolder(folderId, textClauses, pageToken = '') {
      const nameFilter = textClauses.map(t => `name+contains+'${encodeURIComponent(t).replace(/'/g,"%27")}'`).join('+and+');
      const q = `'${folderId}'+in+parents+and+trashed=false` + (nameFilter ? '+and+' + nameFilter : '');
      const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,mimeType,parents,modifiedTime),nextPageToken&pageSize=200${supports}&pageToken=${pageToken}&key=${API_KEY}`;
      const r = await fetch(url); return r.json();
    }

    // 遞迴搜尋（並行）
    async function searchRecursively(folderId, textClauses, out) {
      let token = '';
      do {
        const data = await limit(() => listInFolder(folderId, textClauses, token));
        if (data.files?.length) {
          const subs = [];
          for (const f of data.files) {
            if (f.mimeType === 'application/vnd.google-apps.folder') subs.push(f.id);
            else out.push(f);
          }
          await Promise.all(subs.map(id => searchRecursively(id, textClauses, out)));
        }
        token = data.nextPageToken || '';
      } while (token);
    }

    // Lot 快速全域搜尋
    async function fastLotSearch(lot) {
      let token = ''; const out = [];
      const filter = `name+contains+'${encodeURIComponent(lot).replace(/'/g,"%27")}'`;
      do {
        const url = `https://www.googleapis.com/drive/v3/files?q=${filter}+and+trashed=false&fields=files(id,name,parents,modifiedTime),nextPageToken&pageSize=200${supports}&pageToken=${token}&key=${API_KEY}`;
        const j = await fetch(url).then(r => r.json());
        if (j.files) out.push(...j.files);
        token = j.nextPageToken || '';
      } while (token);
      return out;
    }

    function resetTable() {
      document.getElementById('resultsTable').innerHTML = `
        <tr>
          <th>#</th>
          <th>Filename</th>
          <th>Folder</th>
          <th>Last Modified</th>
          <th>Action</th>
        </tr>`;
    }

    function clearResults() {
      document.getElementById('productSelect').value = '';
      document.getElementById('lotInput').value = '';
      resetTable(); document.getElementById('statusMsg').textContent = '';
    }

    async function searchFiles() {
      const start = Date.now();
      const product = document.getElementById('productSelect').value.trim();
      const lot     = document.getElementById('lotInput').value.trim();
      const status  = document.getElementById('statusMsg');
      const table   = document.getElementById('resultsTable');

      resetTable();
      status.textContent = '⏳ 正在搜尋，請稍候…';

      const isLot = /^\d{6,}$/.test(lot);
      let files = [];

      try {
        if (isLot && !product) {
          // 僅 Lot → 全域快速
          files = await fastLotSearch(lot);
        } else {
          // 品名 或 品名+Lot（或 Lot 不是純數字），遞迴掃 Root
          const clauses = [];
          if (product) clauses.push(product);
          if (lot)     clauses.push(lot);
          const tmp = [];
          await searchRecursively(FOLDER_ID, clauses, tmp);
          files = tmp;
        }

        // 批次取資料夾名稱、排序與呈現
        const parentIds = files.flatMap(f => f.parents || []);
        const folderMap = await getFolderNames(parentIds);
        files.sort((a,b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));

        files.forEach((f, i) => {
          const row = table.insertRow();
          row.insertCell(0).innerText = i + 1;
          row.insertCell(1).innerText = f.name;
          row.insertCell(2).innerText = folderMap[f.parents?.[0]] || '';
          row.insertCell(3).innerText = new Date(f.modifiedTime).toLocaleString();
          const a = document.createElement('a');
          a.href = `https://drive.google.com/uc?id=${f.id}&export=download`;
          a.innerText = 'Download';
          row.insertCell(4).appendChild(a);
        });

        const secs = ((Date.now() - start) / 1000).toFixed(2);
        status.textContent = `✅ 找到 ${files.length} 筆結果，用時 ${secs} 秒`;
      } catch (e) {
        console.error(e);
        status.textContent = '⚠️ 發生錯誤：' + (e?.message || 'Unknown error');
      }
    }
  </script>
</body>
</html>
