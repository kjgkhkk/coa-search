<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CoA Download</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Gunster-like minimalist theme (no header/footer) ===== */
    :root{
      --blue:#0071BC; --blue-d:#005A99;
      --ink:#2d333a; --muted:#6b7785; --line:#d6e1ef;
      --bg:#fff; --bg-soft:#f5f7fa;
      --radius:6px;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg-soft);color:var(--ink);
         font-family:Arial,"Noto Sans",system-ui,sans-serif}
    .wrap{max-width:1080px;margin:0 auto;padding:16px}
    h2{margin:0 0 12px;font-size:22px}
    .card{background:#fff;border:1px solid var(--line);border-radius:8px;padding:14px}

    /* Controls */
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:14px;color:#3b4652;margin-right:4px}
    select,input{min-height:34px;border:1px solid var(--line);border-radius:var(--radius);
                 padding:6px 10px;background:#fff}
    input::placeholder{color:#9aa3ad}
    .btn{min-height:34px;border:1px solid #b9c8dc;border-radius:var(--radius);
         background:#efefef;cursor:pointer;padding:6px 14px;font-weight:700}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .status{margin:8px 0 6px;color:var(--muted);font-size:13px}

    /* Table */
    .tablewrap{border:1px solid var(--line);border-radius:8px;overflow:auto;background:#fff}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{
      background:#1195e3;color:#fff;font-weight:700;
      border-bottom:1px solid #0b72b4; position:sticky; top:0;
    }
    th,td{padding:10px 12px;border-right:1px solid #e6eef7}
    th:last-child,td:last-child{border-right:none}
    tbody tr{border-top:1px solid #eef4fb}
    tbody tr:hover{background:#f8fbff}
    .title a{color:#167ac6;text-decoration:none}
    .title a:hover{text-decoration:underline}

    /* Tube/Cap pair */
    .pair{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pair > span{font-size:14px;color:#3b4652}
    @media (max-width:720px){ .controls{gap:6px} .pair{gap:6px} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>CoA Download</h2>

      <!-- Controls -->
      <div class="controls">
        <label>Product:</label>
        <select id="productSelect"></select>

        <div id="lotSingle" style="display:none;">
          <label style="margin-left:8px;">Lot:</label>
          <input id="lotInput" type="text" inputmode="numeric" placeholder="e.g. 107043" />
        </div>

        <div id="lotPair" class="pair" style="display:none;">
          <span>Tube Lot:</span>
          <input id="lotTube" type="text" inputmode="numeric" placeholder="e.g. 107043" />
          <span>Cap Lot:</span>
          <input id="lotCap" type="text" inputmode="numeric" placeholder="e.g. 250702" />
        </div>

        <button id="searchBtn" class="btn" disabled>Search</button>
      </div>

      <div id="status" class="status">Please select product and enter Lot.</div>

      <!-- Result table -->
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th class="title">Title</th>
              <th style="width:160px;">Published</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <!-- rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== Google Drive settings (use your real values) =====
    const API_KEY   = 'AIzaSyCHe4kvj5Mgv9MTdS9rL5Dxrg8d2qrTkzI';
    const FOLDER_ID = '1cstVGEu9aSqYnSMNJsbH_-2s1wtn-jsj';
    const DRIVE_ID  = ''; // shared drive id if needed; else leave empty
    const supports  = '&supportsAllDrives=true&includeItemsFromAllDrives=true';

    // ===== Product groups (optgroup) =====
    const GROUPS = [
      ["Separate 8-strip", [
        "MB-P08B","MB-P08D","MB-Q100","MB-Q100C","MB-Q100W","MB-Q200","MB-Q200W","MB-QR4"
      ]],
      ["Tube+Attached 8-strip", [
        "MB-P02-A","MB-P02D","MB-P08A","MB-P08AD",
        "MB-P08A(B)","MB-P08A(G)","MB-P08A(R)","MB-P08A(P)","MB-P08A(Y)","MB-P08A(O)",
        "MB-P08AD (B)","MB-P08AD (G)","MB-P08AD (R)","MB-P08AD (P)","MB-P08AD (Y)","MB-P08AD (O)",
        "MB-E17"
      ]],
      ["96 & 384 Plates", [
        "MB-P96","MB-P96-T","MB-Q96","MB-Q96-S","MB-Q96-LN","MB-Q96-LP","MB-Q96-LBR","MB-Q96-LBR-W","MB-384","MB-384W"
      ]],
      ["Film", ["MB-PSM","MB-QSM","MB-BQSM","MB-ASM","MB-ESM"]]
    ];
    const separateProducts = new Set(GROUPS[0][1]);

    // ===== Build product dropdown =====
    const sel = document.getElementById('productSelect');
    function buildDropdown(){
      sel.innerHTML = '<option value="">Please Select…</option>';
      GROUPS.forEach(([label, items])=>{
        const og = document.createElement('optgroup');
        og.label = label;
        items.forEach(p=>{
          const opt = document.createElement('option');
          opt.value = p; opt.textContent = p;
          og.appendChild(opt);
        });
        sel.appendChild(og);
      });
    }
    buildDropdown();

    // ===== UI logic: lot fields + button enable =====
    const lotSingle = document.getElementById('lotSingle');
    const lotPair   = document.getElementById('lotPair');
    const lotInput  = document.getElementById('lotInput');
    const lotTube   = document.getElementById('lotTube');
    const lotCap    = document.getElementById('lotCap');
    const searchBtn = document.getElementById('searchBtn');
    const statusEl  = document.getElementById('status');
    const tbody     = document.getElementById('tbody');

    function isDigits(s){ return /^\d+$/.test(s.trim()); }

    function refreshLotUI(){
      const p = sel.value;
      const showPair = separateProducts.has(p);
      lotSingle.style.display = p && !showPair ? 'inline-flex' : 'none';
      lotPair.style.display   = p && showPair  ? 'inline-flex' : 'none';
      validate();
    }

    function validate(){
      const p = sel.value;
      let ok = false;
      if (!p){ ok = false; }
      else if (separateProducts.has(p)){
        const t = lotTube.value.trim(), c = lotCap.value.trim();
        ok = (isDigits(t) || isDigits(c)); // at least one
      }else{
        ok = isDigits(lotInput.value.trim());
      }
      searchBtn.disabled = !ok;
      statusEl.textContent = ok ? 'Ready. Click Search to query.' : 'Please select product and enter Lot.';
    }

    sel.addEventListener('change', refreshLotUI);
    [lotInput, lotTube, lotCap].forEach(el=>{
      el.addEventListener('input', validate);
      el.addEventListener('keydown', e=>{ if(e.key==='Enter' && !searchBtn.disabled){ doSearch(); } });
    });
    searchBtn.addEventListener('click', doSearch);

    // ===== Drive query helpers =====
    function qEncode(s){ return encodeURIComponent(s).replace(/'/g,"%27"); }

    async function searchGlobal(clauses){
      // Full-drive (or shared drive) search with "name contains" ANDed clauses
      const filter = clauses.map(t=>`name contains '${qEncode(t)}'`).join(' and ');
      let q = `${filter} and trashed=false and mimeType!='application/vnd.google-apps.folder'`;
      const base = `https://www.googleapis.com/drive/v3/files?fields=files(id,name,modifiedTime),nextPageToken&pageSize=200${supports}&key=${API_KEY}`;
      const corp = DRIVE_ID ? `&corpora=drive&driveId=${DRIVE_ID}` : '';
      let token = '', out = [];
      do{
        const url = `${base}${corp}&q=${q}${token?`&pageToken=${token}`:''}`;
        const j = await fetch(url).then(r=>r.json());
        out.push(...(j.files||[]));
        token = j.nextPageToken || '';
      }while(token);
      return out;
    }

    // Fallback: recursive scan within Folder ID (slower but constrained to your tree)
    async function listSubfolders(folderId, pageToken=''){
      const q = `'${folderId}' in parents and trashed=false and mimeType='application/vnd.google-apps.folder'`;
      const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id),nextPageToken&pageSize=200${supports}&pageToken=${pageToken}&key=${API_KEY}`;
      return fetch(url).then(r=>r.json());
    }
    async function listFilesInFolderFiltered(folderId, clauses, pageToken=''){
      const nameFilter = clauses.map(t=>`name contains '${qEncode(t)}'`).join(' and ');
      const q = `'${folderId}' in parents and trashed=false and mimeType!='application/vnd.google-apps.folder' and ${nameFilter}`;
      const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id,name,modifiedTime),nextPageToken&pageSize=200${supports}&pageToken=${pageToken}&key=${API_KEY}`;
      return fetch(url).then(r=>r.json());
    }
    async function searchRecursive(folderId, clauses, out){
      let token=''; do{
        const j = await listFilesInFolderFiltered(folderId, clauses, token);
        out.push(...(j.files||[]));
        token = j.nextPageToken || '';
      }while(token);
      let ft=''; const subs=[];
      do{
        const d = await listSubfolders(folderId, ft);
        subs.push(...(d.files||[]).map(f=>f.id));
        ft = d.nextPageToken || '';
      }while(ft);
      for (const id of subs){ await searchRecursive(id, clauses, out); }
    }

    function render(items){
      // dedupe + sort desc by modifiedTime
      const map = new Map(); items.forEach(f=>map.set(f.id,f));
      const list = [...map.values()].sort((a,b)=> (b.modifiedTime||'').localeCompare(a.modifiedTime||''));

      tbody.innerHTML = list.map(f=>{
        const date = f.modifiedTime ? new Date(f.modifiedTime).toISOString().slice(0,10) : '';
        const href = `https://drive.google.com/uc?id=${f.id}&export=download`;
        return `<tr>
          <td class="title"><a href="${href}" target="_blank" rel="noopener">${f.name}</a></td>
          <td>${date}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="2">❌ No files found</td></tr>`;
      statusEl.textContent = `✅ Found ${list.length} records`;
    }

    async function doSearch(){
      searchBtn.disabled = true;
      tbody.innerHTML = '';
      statusEl.textContent = 'Searching…';

      const p = sel.value;
      const isSeparate = separateProducts.has(p);
      const clausesList = [];

      if (isSeparate){
        const t = lotTube.value.trim(), c = lotCap.value.trim();
        if (isDigits(t)) clausesList.push([p, `Lot-${t}`]);
        if (isDigits(c)) clausesList.push([p+'CAP', `Lot-${c}`]);
      }else{
        const lot = lotInput.value.trim();
        clausesList.push([p, `Lot-${lot}`]);
      }

      try{
        let results = [];
        // Prefer global search (fast). If nothing returns, fallback to recursive under FOLDER_ID.
        for (const clauses of clausesList){
          const found = await searchGlobal(clauses);
          if (found.length) { results.push(...found); }
          else {
            const bag=[]; await searchRecursive(FOLDER_ID, clauses, bag); results.push(...bag);
          }
        }
        render(results);
      }catch(e){
        console.error(e);
        statusEl.textContent = '⚠ Search failed';
      }finally{
        validate(); // re-enable if inputs still valid
      }
    }

    // init
    refreshLotUI();
  </script>
</body>
</html>
