<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gunster Biotech — CoA Search & Download (Simple)</title>
<style>
  body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;padding:16px}
  h1{font-size:20px;margin:0 0 12px}
  input,button{font-size:14px}
  input{padding:8px 10px;min-width:260px}
  button{padding:8px 12px;margin-left:6px}
  table{margin-top:12px;border-collapse:collapse;width:100%}
  td,th{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:#f7f7f7}
</style>
<script>
// ====== CONFIG ======
const API_KEY   = 'AIzaSyCHe4kvj5Mgv9MTdS9rL5Dxrg8d2qrTkzI';
const FOLDER_ID = '1cstVGEu9aSqYnSMNJsbH_-2s1wtn-jsj'; // 目前指向最外層資料夾
const DRIVE_ID  = ''; // 若這個資料夾是在『共享雲端硬碟』，把 Drive ID 貼到這裡；否則留空

function escQ(s){return (s||'').replace(/["'\\]/g, m=>({"'":"\\'","\"":"\\\"","\\":"\\\\"}[m]));}

async function searchFiles(){
  const kw = document.getElementById('query').value.trim();
  const tbody = document.getElementById('results');
  tbody.innerHTML = '<tr><td colspan="3">Searching...</td></tr>';

  const url = new URL('https://www.googleapis.com/drive/v3/files');
  // 只搜尋這個資料夾底下（不會往子資料夾）：
  const q = `'${FOLDER_ID}' in parents and trashed=false` + (kw? ` and name contains '${escQ(kw)}'` : '');
  url.searchParams.set('q', q);
  url.searchParams.set('key', API_KEY);
  url.searchParams.set('fields', 'files(id,name,webViewLink,webContentLink),nextPageToken');
  url.searchParams.set('pageSize', '1000');
  url.searchParams.set('orderBy', 'modifiedTime desc');
  url.searchParams.set('supportsAllDrives', 'true');
  url.searchParams.set('includeItemsFromAllDrives', 'true');
  if (DRIVE_ID){
    url.searchParams.set('corpora', 'drive');
    url.searchParams.set('driveId', DRIVE_ID);
  } else {
    url.searchParams.set('corpora', 'allDrives');
  }

  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP ' + r.status);
    const data = await r.json();
    renderRows(data.files||[]);
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="3">Search failed: ${e.message}</td></tr>`;
  }
}

function renderRows(files){
  const tbody = document.getElementById('results');
  tbody.innerHTML = '';
  if(!files.length){
    tbody.innerHTML = '<tr><td colspan="3">No files found.</td></tr>';
    return;
  }
  files.forEach((f,i)=>{
    const view = f.webViewLink ? `<a href="${f.webViewLink}" target="_blank">View</a>` : '';
    const dl   = f.webContentLink ? ` | <a href="${f.webContentLink}" target="_blank">Download</a>` : '';
    tbody.insertAdjacentHTML('beforeend', `<tr><td>${i+1}</td><td>${f.name}</td><td>${view}${dl}</td></tr>`);
  });
}

function clearSearch(){
  document.getElementById('query').value='';
  document.getElementById('results').innerHTML='';
}

window.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('btnSearch').addEventListener('click', searchFiles);
  document.getElementById('btnClear').addEventListener('click', clearSearch);
  document.getElementById('query').addEventListener('keydown', e=>{ if(e.key==='Enter') searchFiles();});
});
</script>
</head>
<body>
  <h1>Gunster Biotech — CoA Search & Download (Simple)</h1>
  <input id="query" type="text" placeholder="Type a LOT or filename keyword…" />
  <button id="btnSearch">Search</button>
  <button id="btnClear">Clear</button>

  <table>
    <thead><tr><th style="width:60px">#</th><th>Filename</th><th style="width:220px">Action</th></tr></thead>
    <tbody id="results"></tbody>
  </table>
</body>
</html>
